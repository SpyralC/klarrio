# install nginx and gunicorn
sudo apt-get install -y nginx
pip3 install gunicorn
gunicorn --bind 0.0.0.0:8080 demo.run:app

sudo apt update && sudo apt install supervisor
sudo systemctl status supervisor
cd /etc/supervisor/conf.d
sudo touch gunicorn.conf 
sudo nano gunicorn.conf 

sudo mkdir /var/log/gunicorn

sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl status

cd /etc/nginx/sites-available/

sudo touch flask.conf
sudo nano flask.conf 

sudo ln flask.conf /etc/nginx/sites-enabled/

sudo nano /etc/nginx/nginx.conf
#server_names_hash_bucket_size  256;
sudo nginx -t

sudo service nginx restart


#   Configuring Gunicorn
cd /home/ubuntu/klarrio
gunicorn --bind 0.0.0.0:5000 run:app
deactivate
sudo nano /etc/systemd/system/klarrio.service
sudo systemctl start klarrio
sudo systemctl enable klarrio
sudo systemctl status klarrio

#   Configuring Nginx to Proxy Requests
sudo nano /etc/nginx/sites-available/klarrio

server {
    listen 80;
    server_name ec2-3-106-138-107.ap-southeast-2.compute.amazonaws.com;

    location / {
        include proxy_params;
        proxy_pass http://unix:/home/ubuntu/klarrio/klarrio.sock;
    }
}

sudo ln -s /etc/nginx/sites-available/klarrio /etc/nginx/sites-enabled
sudo nginx -t
sudo systemctl restart nginx
sudo ufw delete allow 5000
sudo ufw allow 'Nginx Full'
